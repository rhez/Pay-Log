<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NVS Pay Log</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="app-shell">
    <div class="window-bar">
      <div class="window-menu">
        <button type="button" class="menu-button" aria-haspopup="true" aria-expanded="false">
          <span class="menu-line"></span>
          <span class="menu-line"></span>
          <span class="menu-line"></span>
        </button>
        <div class="menu-dropdown" role="menu">
          <button type="button" class="menu-item" role="menuitem">Change Password</button>
        </div>
      </div>
      <div class="window-title">NVS Pay Log</div>
    </div>

    <div class="content">
      <div class="row">
        <div class="label">Member:</div>
        <div class="input-group">
          <select id="memberSelect"></select>
        </div>
        <button class="button" id="importMembersButton" type="button">Import Members</button>
        <input id="memberImportInput" type="file" accept=".csv,.xlsx" hidden />
      </div>

      <div class="row date-row">
        <div class="label">Date:</div>
        <div class="input-group">
          <input type="date" id="transactionDate" />
        </div>
        <div class="balance-group">
          <div class="label balance-label">Balance:</div>
          <div class="balance" id="balanceValue">$0.00</div>
        </div>
      </div>

      <div class="row">
        <div class="label">Description:</div>
        <div class="input-group">
          <textarea></textarea>
        </div>
      </div>

      <div class="row amount-row">
        <div class="label">Amount:</div>
        <div class="input-group">
          <input type="number" id="transactionAmount" step="0.01" />
          <div class="radio-set">
            <label><input type="radio" name="type" value="charge" checked /> Charge (-)</label>
            <label><input type="radio" name="type" value="credit" /> Credit (+)</label>
          </div>
        </div>
      </div>

      <div class="row" style="padding-top: 4px;">
        <div class="label" style="width: auto;">Recent Transactions:</div>
      </div>

      <div class="transactions">
        <div class="table-header">
          <span>Date</span>
          <span>Description</span>
          <span>Amount</span>
        </div>
        <div class="table-body" id="transactionsBody"></div>
      </div>

      <div class="footer-actions">
        <button class="button" id="undoTransactionButton" type="button">
          ◀ Undo Last Transaction
        </button>
        <button class="button" type="button">Apply Transaction ▶</button>
      </div>

      <div class="status">
        <span class="status-emoji" aria-hidden="true">✅</span>
        <div class="status-details">
          <div class="status-message">John Smith (ID: 001) fetched successfully</div>
          <div class="status-grid">
            <div class="status-row">
              <span class="status-label">Server connection:</span>
              <span class="status-value" id="statusServer">pending</span>
            </div>
            <div class="status-row">
              <span class="status-label">Database connection:</span>
              <span class="status-value" id="statusDatabase">pending</span>
            </div>
            <div class="status-row">
              <span class="status-label">Load members:</span>
              <span class="status-value" id="statusMembers">pending</span>
            </div>
            <div class="status-row">
              <span class="status-label">Load transactions for member:</span>
              <span class="status-value" id="statusTransactions">pending</span>
            </div>
            <div class="status-row">
              <span class="status-label">Apply transaction:</span>
              <span class="status-value" id="statusApply">pending</span>
            </div>
            <div class="status-row">
              <span class="status-label">Validate date (yyyy-mm-dd):</span>
              <span class="status-value" id="statusDate">pending</span>
            </div>
            <div class="status-row">
              <span class="status-label">Validate amount ([$]&lt;num&gt;[.dd]):</span>
              <span class="status-value" id="statusAmount">pending</span>
            </div>
            <div class="status-row">
              <span class="status-label">Undo last transaction:</span>
              <span class="status-value" id="statusUndo">pending</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const menu = document.querySelector('.window-menu');
    const menuButton = document.querySelector('.menu-button');
    const menuItems = document.querySelectorAll('.menu-item');
    const memberSelect = document.querySelector('#memberSelect');
    const balanceValue = document.querySelector('#balanceValue');
    const transactionsBody = document.querySelector('#transactionsBody');
    const importMembersButton = document.querySelector('#importMembersButton');
    const memberImportInput = document.querySelector('#memberImportInput');
    const transactionDate = document.querySelector('#transactionDate');
    const transactionAmount = document.querySelector('#transactionAmount');
    const descriptionInput = document.querySelector('textarea');
    const undoTransactionButton = document.querySelector('#undoTransactionButton');
    const applyTransactionButton = document.querySelector(
      '.footer-actions .button:last-child'
    );
    const statusServer = document.querySelector('#statusServer');
    const statusDatabase = document.querySelector('#statusDatabase');
    const statusMembers = document.querySelector('#statusMembers');
    const statusTransactions = document.querySelector('#statusTransactions');
    const statusApply = document.querySelector('#statusApply');
    const statusDate = document.querySelector('#statusDate');
    const statusAmount = document.querySelector('#statusAmount');
    const statusUndo = document.querySelector('#statusUndo');

    const today = new Date().toISOString().split('T')[0];
    transactionDate.value = today;

    const setStatus = (element, value) => {
      if (element) {
        element.textContent = value;
      }
    };

    const closeMenu = () => {
      menu.classList.remove('open');
      menuButton.setAttribute('aria-expanded', 'false');
    };

    menuButton.addEventListener('click', (event) => {
      event.stopPropagation();
      const isOpen = menu.classList.contains('open');
      if (isOpen) {
        closeMenu();
      } else {
        menu.classList.add('open');
        menuButton.setAttribute('aria-expanded', 'true');
      }
    });

    document.addEventListener('click', (event) => {
      if (!event.target.closest('.window-menu')) {
        closeMenu();
      }
    });

    menuItems.forEach((item) => {
      item.addEventListener('click', () => {
        closeMenu();
      });
    });

    const formatCurrency = (value) => {
      const amount = Number(value || 0);
      const formatted = Math.abs(amount).toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
      return `${amount >= 0 ? '+' : '-'}$${formatted}`;
    };

    const renderTransactions = (transactions, memberId) => {
      transactionsBody.innerHTML = '';

      const filteredTransactions = memberId
        ? transactions.filter((transaction) => transaction.member_id === memberId)
        : transactions;

      if (!filteredTransactions.length) {
        const emptyRow = document.createElement('div');
        emptyRow.className = 'table-row';
        emptyRow.innerHTML =
          '<div></div><div>No transactions</div><div class="amount"></div>';
        transactionsBody.appendChild(emptyRow);
        return;
      }

      filteredTransactions.forEach((transaction) => {
        const row = document.createElement('div');
        row.className = 'table-row';
        row.innerHTML = `
          <div>${transaction.date}</div>
          <div>${transaction.description || ''}</div>
          <div class="amount">${formatCurrency(transaction.amount)}</div>
        `;
        transactionsBody.appendChild(row);
      });
    };

    const loadMember = async (memberId) => {
      setStatus(statusTransactions, 'loading');
      const response = await fetch(`/api/members/${memberId}`);
      if (!response.ok) {
        balanceValue.textContent = '$0.00';
        renderTransactions([], memberId);
        setStatus(statusTransactions, 'failed');
        return;
      }

      const data = await response.json();
      balanceValue.textContent = `$${Number(data.member.balance || 0).toLocaleString(
        undefined,
        {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }
      )}`;
      renderTransactions(data.transactions || [], memberId);
      setStatus(
        statusTransactions,
        data.transactions && data.transactions.length ? 'loaded' : 'none'
      );
    };

    const applyTransaction = async () => {
      setStatus(statusApply, 'pending');
      const selectedId = Number(memberSelect.value);
      if (!Number.isInteger(selectedId)) {
        setStatus(statusApply, 'failed');
        return;
      }

      const amountValue = Number(transactionAmount.value);
      const dateValid = /^\d{4}-\d{2}-\d{2}$/.test(transactionDate.value);
      setStatus(statusDate, dateValid ? 'valid' : 'invalid');

      const amountValid = !Number.isNaN(amountValue) && amountValue > 0;
      setStatus(statusAmount, amountValid ? 'valid' : 'invalid');

      if (!dateValid || !amountValid) {
        setStatus(statusApply, 'failed');
        return;
      }

      const selectedType = document.querySelector('input[name="type"]:checked');
      const payload = {
        date: transactionDate.value,
        description: descriptionInput.value || '',
        amount: amountValue,
        type: selectedType?.value || 'charge',
      };

      const response = await fetch(`/api/members/${selectedId}/transactions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        await loadMember(selectedId);
        transactionAmount.value = '';
        descriptionInput.value = '';
        setStatus(statusApply, 'success');
      } else {
        setStatus(statusApply, 'failed');
      }
    };

    const undoLastTransaction = async () => {
      setStatus(statusUndo, 'pending');
      const selectedId = Number(memberSelect.value);
      if (!Number.isInteger(selectedId)) {
        setStatus(statusUndo, 'failed');
        return;
      }

      const response = await fetch(
        `/api/members/${selectedId}/transactions/last`,
        {
          method: 'DELETE',
        }
      );

      if (response.ok) {
        await loadMember(selectedId);
        setStatus(statusUndo, 'success');
      } else {
        setStatus(statusUndo, 'failed');
      }
    };

    const loadMembers = async () => {
      setStatus(statusMembers, 'loading');
      const response = await fetch('/api/members');
      if (!response.ok) {
        memberSelect.innerHTML = '<option>No members</option>';
        memberSelect.disabled = true;
        setStatus(statusServer, 'failed');
        setStatus(statusDatabase, 'failed');
        setStatus(statusMembers, 'failed');
        return;
      }

      setStatus(statusServer, 'connected');
      setStatus(statusDatabase, 'connected');

      const data = await response.json();
      memberSelect.innerHTML = '';

      if (!data.members.length) {
        memberSelect.innerHTML = '<option>No members</option>';
        memberSelect.disabled = true;
        balanceValue.textContent = '$0.00';
        renderTransactions([], null);
        setStatus(statusMembers, 'none');
        return;
      }

      data.members.forEach((member) => {
        const option = document.createElement('option');
        option.value = member.id;
        option.textContent = member.displayName;
        memberSelect.appendChild(option);
      });

      const firstMember = data.members[0];
      memberSelect.value = firstMember.id;
      memberSelect.disabled = false;
      await loadMember(firstMember.id);
      setStatus(statusMembers, 'loaded');
    };

    memberSelect.addEventListener('change', (event) => {
      const selectedId = Number(event.target.value);
      if (Number.isInteger(selectedId)) {
        loadMember(selectedId);
      }
    });

    applyTransactionButton.addEventListener('click', () => {
      applyTransaction();
    });

    undoTransactionButton.addEventListener('click', () => {
      undoLastTransaction();
    });

    importMembersButton.addEventListener('click', () => {
      memberImportInput.click();
    });

    memberImportInput.addEventListener('change', async (event) => {
      const [file] = event.target.files;
      if (!file) {
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      const previewResponse = await fetch('/api/members/import/preview', {
        method: 'POST',
        body: formData,
      });

      if (!previewResponse.ok) {
        memberImportInput.value = '';
        return;
      }

      const previewData = await previewResponse.json();
      if (previewData.toDelete > 0) {
        const confirmed = window.confirm(
          `Importing will remove ${previewData.toDelete} member(s) not listed and their transactions. Continue?`
        );
        if (!confirmed) {
          memberImportInput.value = '';
          return;
        }
      }

      const response = await fetch('/api/members/import', {
        method: 'POST',
        body: formData,
      });

      if (response.ok) {
        await loadMembers();
      }

      memberImportInput.value = '';
    });

    loadMembers();
  </script>
</body>
</html>
