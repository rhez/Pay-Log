<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NVS Pay Log</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="app-shell">
    <div class="window-bar">
      <div class="window-menu">
        <button type="button" class="menu-button" aria-haspopup="true" aria-expanded="false">
          <span class="menu-line"></span>
          <span class="menu-line"></span>
          <span class="menu-line"></span>
        </button>
        <div class="menu-dropdown" role="menu">
          <button type="button" class="menu-item" role="menuitem">Change Password</button>
        </div>
      </div>
      <div class="window-title">NVS Pay Log</div>
    </div>

    <div class="content">
      <div class="row">
        <div class="label">Member:</div>
        <div class="input-group">
          <select id="memberSelect"></select>
        </div>
        <button class="button" id="importMembersButton" type="button">Import Members</button>
        <input id="memberImportInput" type="file" accept=".csv,.xlsx" hidden />
      </div>

      <div class="row date-row">
        <div class="label">Date:</div>
        <div class="input-group">
          <input type="text" value="2025-07-29" />
        </div>
        <div class="balance-group">
          <div class="label balance-label">Balance:</div>
          <div class="balance" id="balanceValue">$0.00</div>
        </div>
      </div>

      <div class="row">
        <div class="label">Description:</div>
        <div class="input-group">
          <textarea></textarea>
        </div>
      </div>

      <div class="row amount-row">
        <div class="label">Amount:</div>
        <div class="input-group">
          <input type="text" />
          <div class="radio-set">
            <label><input type="radio" name="type" checked /> Charge (-)</label>
            <label><input type="radio" name="type" /> Credit (+)</label>
          </div>
        </div>
      </div>

      <div class="row" style="padding-top: 4px;">
        <div class="label" style="width: auto;">Recent Transactions:</div>
      </div>

      <div class="transactions">
        <div class="table-header">
          <span>Date</span>
          <span>Description</span>
          <span>Amount</span>
        </div>
        <div class="table-body" id="transactionsBody"></div>
      </div>

      <div class="footer-actions">
        <button class="button" type="button">◀ Undo Last Transaction</button>
        <button class="button" type="button">Apply Transaction ▶</button>
      </div>

      <div class="status">
        <span class="status-emoji" aria-hidden="true">✅</span>
        <span>John Smith (ID: 001) fetched successfully</span>
      </div>
    </div>
  </div>
  <script>
    const menu = document.querySelector('.window-menu');
    const menuButton = document.querySelector('.menu-button');
    const menuItems = document.querySelectorAll('.menu-item');
    const memberSelect = document.querySelector('#memberSelect');
    const balanceValue = document.querySelector('#balanceValue');
    const transactionsBody = document.querySelector('#transactionsBody');
    const importMembersButton = document.querySelector('#importMembersButton');
    const memberImportInput = document.querySelector('#memberImportInput');

    const closeMenu = () => {
      menu.classList.remove('open');
      menuButton.setAttribute('aria-expanded', 'false');
    };

    menuButton.addEventListener('click', (event) => {
      event.stopPropagation();
      const isOpen = menu.classList.contains('open');
      if (isOpen) {
        closeMenu();
      } else {
        menu.classList.add('open');
        menuButton.setAttribute('aria-expanded', 'true');
      }
    });

    document.addEventListener('click', (event) => {
      if (!event.target.closest('.window-menu')) {
        closeMenu();
      }
    });

    menuItems.forEach((item) => {
      item.addEventListener('click', () => {
        closeMenu();
      });
    });

    const formatCurrency = (value) => {
      const amount = Number(value || 0);
      const formatted = Math.abs(amount).toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
      return `${amount >= 0 ? '+' : '-'}$${formatted}`;
    };

    const renderTransactions = (transactions) => {
      transactionsBody.innerHTML = '';

      if (!transactions.length) {
        const emptyRow = document.createElement('div');
        emptyRow.className = 'table-row';
        emptyRow.innerHTML =
          '<div></div><div>No transactions</div><div class="amount"></div>';
        transactionsBody.appendChild(emptyRow);
        return;
      }

      transactions.forEach((transaction) => {
        const row = document.createElement('div');
        row.className = 'table-row';
        row.innerHTML = `
          <div>${transaction.date}</div>
          <div>${transaction.description || ''}</div>
          <div class="amount">${formatCurrency(transaction.amount)}</div>
        `;
        transactionsBody.appendChild(row);
      });
    };

    const loadMember = async (memberId) => {
      const response = await fetch(`/api/members/${memberId}`);
      if (!response.ok) {
        balanceValue.textContent = '$0.00';
        renderTransactions([]);
        return;
      }

      const data = await response.json();
      balanceValue.textContent = `$${Number(data.member.balance || 0).toLocaleString(
        undefined,
        {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }
      )}`;
      renderTransactions(data.transactions || []);
    };

    const loadMembers = async () => {
      const response = await fetch('/api/members');
      if (!response.ok) {
        memberSelect.innerHTML = '<option>No members</option>';
        memberSelect.disabled = true;
        return;
      }

      const data = await response.json();
      memberSelect.innerHTML = '';

      if (!data.members.length) {
        memberSelect.innerHTML = '<option>No members</option>';
        memberSelect.disabled = true;
        balanceValue.textContent = '$0.00';
        renderTransactions([]);
        return;
      }

      data.members.forEach((member) => {
        const option = document.createElement('option');
        option.value = member.id;
        option.textContent = member.displayName;
        memberSelect.appendChild(option);
      });

      const firstMember = data.members[0];
      memberSelect.value = firstMember.id;
      memberSelect.disabled = false;
      await loadMember(firstMember.id);
    };

    memberSelect.addEventListener('change', (event) => {
      const selectedId = Number(event.target.value);
      if (Number.isInteger(selectedId)) {
        loadMember(selectedId);
      }
    });

    importMembersButton.addEventListener('click', () => {
      memberImportInput.click();
    });

    memberImportInput.addEventListener('change', async (event) => {
      const [file] = event.target.files;
      if (!file) {
        return;
      }

      if (file.name.toLowerCase().endsWith('.xlsx')) {
        const confirmed = window.confirm(
          'Importing this .xlsx will remove members not in the file (and their transactions). Continue?'
        );
        if (!confirmed) {
          memberImportInput.value = '';
          return;
        }
      }

      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch('/api/members/import', {
        method: 'POST',
        body: formData,
      });

      if (response.ok) {
        await loadMembers();
      }

      memberImportInput.value = '';
    });

    loadMembers();
  </script>
</body>
</html>
