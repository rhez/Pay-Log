<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NVS Pay Log</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="app-shell">
    <div class="window-bar">
      <div class="window-menu">
        <button type="button" class="menu-button" aria-haspopup="true" aria-expanded="false">
          <span class="menu-line"></span>
          <span class="menu-line"></span>
          <span class="menu-line"></span>
        </button>
        <div class="menu-dropdown" role="menu">
          <button type="button" class="menu-item" role="menuitem">Change Password</button>
        </div>
      </div>
      <div class="window-title">NVS Pay Log</div>
    </div>

    <div class="content">
      <div class="row">
        <div class="label">Member:</div>
        <div class="input-group">
          <select id="memberSelect"></select>
        </div>
        <button class="button" id="importMembersButton" type="button">Import Members</button>
        <input id="memberImportInput" type="file" accept=".csv,.xlsx" hidden />
      </div>

      <div class="row date-row">
        <div class="label">Date:</div>
        <div class="input-group">
          <input type="date" id="transactionDate" />
        </div>
        <div class="balance-group">
          <div class="label balance-label">Balance:</div>
          <div class="balance" id="balanceValue">$0.00</div>
        </div>
      </div>

      <div class="row">
        <div class="label">Description:</div>
        <div class="input-group">
          <textarea></textarea>
        </div>
      </div>

      <div class="row amount-row">
        <div class="label">Amount:</div>
        <div class="input-group">
          <input type="text" id="transactionAmount" />
          <div class="radio-set">
            <label><input type="radio" name="type" value="charge" checked /> Charge (-)</label>
            <label><input type="radio" name="type" value="credit" /> Credit (+)</label>
          </div>
        </div>
      </div>

      <div class="row" style="padding-top: 4px;">
        <div class="label" style="width: auto;">Recent Transactions:</div>
      </div>

      <div class="transactions">
        <div class="table-header">
          <span>Date</span>
          <span>Description</span>
          <span>Amount</span>
        </div>
        <div class="table-body" id="transactionsBody"></div>
      </div>

      <div class="footer-actions">
        <button class="button" id="undoTransactionButton" type="button">
          ◀ Undo Last Transaction
        </button>
        <button class="button" type="button">Apply Transaction ▶</button>
      </div>

      <div class="status status-fail" id="statusBar">
        <span class="status-emoji status-fail" id="statusEmoji" aria-hidden="true">❌</span>
        <span class="status-text status-fail" id="statusText">No connection to database.</span>
      </div>
    </div>
  </div>
  <script>
    const menu = document.querySelector('.window-menu');
    const menuButton = document.querySelector('.menu-button');
    const menuItems = document.querySelectorAll('.menu-item');
    const memberSelect = document.querySelector('#memberSelect');
    const balanceValue = document.querySelector('#balanceValue');
    const transactionsBody = document.querySelector('#transactionsBody');
    const importMembersButton = document.querySelector('#importMembersButton');
    const memberImportInput = document.querySelector('#memberImportInput');
    const transactionDate = document.querySelector('#transactionDate');
    const transactionAmount = document.querySelector('#transactionAmount');
    const descriptionInput = document.querySelector('textarea');
    const undoTransactionButton = document.querySelector('#undoTransactionButton');
    const applyTransactionButton = document.querySelector(
      '.footer-actions .button:last-child'
    );
    const statusBar = document.querySelector('#statusBar');
    const statusEmoji = document.querySelector('#statusEmoji');
    const statusText = document.querySelector('#statusText');

    const setStatus = (message, state = 'success') => {
      statusText.textContent = message;
      statusBar.classList.remove('status-success', 'status-fail');
      statusText.classList.remove('status-success', 'status-fail');
      statusEmoji.classList.remove('status-success', 'status-fail');
      if (state === 'success') {
        statusEmoji.textContent = '✅';
        statusBar.classList.add('status-success');
        statusText.classList.add('status-success');
        statusEmoji.classList.add('status-success');
      } else if (state === 'fail') {
        statusEmoji.textContent = '❌';
        statusBar.classList.add('status-fail');
        statusText.classList.add('status-fail');
        statusEmoji.classList.add('status-fail');
      }
    };

    const today = new Date().toISOString().split('T')[0];
    transactionDate.value = today;
    setStatus('No connection to database.', 'fail');

    const closeMenu = () => {
      menu.classList.remove('open');
      menuButton.setAttribute('aria-expanded', 'false');
    };

    menuButton.addEventListener('click', (event) => {
      event.stopPropagation();
      const isOpen = menu.classList.contains('open');
      if (isOpen) {
        closeMenu();
      } else {
        menu.classList.add('open');
        menuButton.setAttribute('aria-expanded', 'true');
      }
    });

    document.addEventListener('click', (event) => {
      if (!event.target.closest('.window-menu')) {
        closeMenu();
      }
    });

    menuItems.forEach((item) => {
      item.addEventListener('click', () => {
        closeMenu();
      });
    });

    const dollarsToCents = (value) => {
      const normalized = String(value || '').replace(/[^0-9.-]/g, '').trim();
      if (!normalized) {
        return null;
      }
      const negative = normalized.startsWith('-');
      const [wholePart, fractionalPart = ''] = normalized.replace('-', '').split('.');
      const cents = `${fractionalPart}00`.slice(0, 2);
      const combined = `${wholePart || '0'}${cents}`;
      const parsed = Number.parseInt(combined, 10);
      if (Number.isNaN(parsed)) {
        return null;
      }
      return negative ? -parsed : parsed;
    };

    const centsToDollars = (cents) => {
      const value = Number(cents);
      if (Number.isNaN(value)) {
        return '0.00';
      }
      const negative = value < 0;
      const absolute = Math.abs(value);
      const dollars = Math.floor(absolute / 100);
      const remainder = String(absolute % 100).padStart(2, '0');
      return `${negative ? '-' : ''}${dollars}.${remainder}`;
    };

    const formatCurrency = (value) => {
      const cents = dollarsToCents(value);
      const normalized = cents === null ? 0 : cents;
      const formatted = centsToDollars(Math.abs(normalized));
      return `${normalized >= 0 ? '+' : '-'}$${formatted}`;
    };

    const renderTransactions = (transactions, memberId) => {
      transactionsBody.innerHTML = '';

      const filteredTransactions = memberId
        ? transactions.filter((transaction) => transaction.member_id === memberId)
        : transactions;

      if (!filteredTransactions.length) {
        return;
      }

      filteredTransactions.forEach((transaction) => {
        const row = document.createElement('div');
        row.className = 'table-row';
        const dateValue = String(transaction.date || '').split('T')[0];
        row.innerHTML = `
          <div>${dateValue}</div>
          <div>${transaction.description || ''}</div>
          <div class="amount">${formatCurrency(transaction.amount)}</div>
        `;
        transactionsBody.appendChild(row);
      });
    };

    const loadMember = async (memberId) => {
      const response = await fetch(`/api/members/${memberId}`);
      if (!response.ok) {
        balanceValue.textContent = '$0.00';
        renderTransactions([], memberId);
        setStatus('Failed to load transactions.', 'fail');
        return;
      }

      const data = await response.json();
      const balanceCents = dollarsToCents(data.member.balance);
      const balanceText = centsToDollars(balanceCents ?? 0);
      balanceValue.textContent = `$${balanceText.replace('-', '')}`;
      renderTransactions(data.transactions || [], memberId);
      setStatus(
        data.transactions && data.transactions.length
          ? 'Transactions loaded.'
          : 'No transactions for this member.',
        'success'
      );
    };

    const applyTransaction = async () => {
      const selectedId = Number(memberSelect.value);
      if (!Number.isInteger(selectedId)) {
        setStatus('Select a member before applying a transaction.', 'fail');
        return;
      }

      const amountCents = dollarsToCents(transactionAmount.value);
      const dateValid = /^\d{4}-\d{2}-\d{2}$/.test(transactionDate.value);
      const amountValid = amountCents !== null && amountCents > 0;

      if (!dateValid || !amountValid) {
        setStatus('Invalid date or amount.', 'fail');
        return;
      }

      const selectedType = document.querySelector('input[name="type"]:checked');
      const payload = {
        date: transactionDate.value,
        description: descriptionInput.value || '',
        amount: centsToDollars(amountCents),
        type: selectedType?.value || 'charge',
      };

      const response = await fetch(`/api/members/${selectedId}/transactions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        await loadMember(selectedId);
        transactionAmount.value = '';
        descriptionInput.value = '';
        setStatus('Transaction applied successfully.', 'success');
      } else {
        setStatus('Failed to apply transaction.', 'fail');
      }
    };

    const undoLastTransaction = async () => {
      const selectedId = Number(memberSelect.value);
      if (!Number.isInteger(selectedId)) {
        setStatus('Select a member before undoing.', 'fail');
        return;
      }

      const response = await fetch(
        `/api/members/${selectedId}/transactions/last`,
        {
          method: 'DELETE',
        }
      );

      if (response.ok) {
        await loadMember(selectedId);
        setStatus('Last transaction undone.', 'success');
      } else {
        setStatus('Failed to undo last transaction.', 'fail');
      }
    };

    const loadMembers = async () => {
      const response = await fetch('/api/members');
      if (!response.ok) {
        memberSelect.innerHTML = '<option>No members</option>';
        memberSelect.disabled = true;
        setStatus('Server or database connection failed.', 'fail');
        return;
      }

      const data = await response.json();
      memberSelect.innerHTML = '';

      if (!data.members.length) {
        memberSelect.innerHTML = '<option>No members</option>';
        memberSelect.disabled = true;
        balanceValue.textContent = '$0.00';
        renderTransactions([], null);
        setStatus('No members loaded.', 'fail');
        return;
      }

      data.members.forEach((member) => {
        const option = document.createElement('option');
        option.value = member.id;
        option.textContent = member.displayName;
        memberSelect.appendChild(option);
      });

      const firstMember = data.members[0];
      memberSelect.value = firstMember.id;
      memberSelect.disabled = false;
      await loadMember(firstMember.id);
      setStatus('Members loaded successfully.', 'success');
    };

    memberSelect.addEventListener('change', (event) => {
      const selectedId = Number(event.target.value);
      if (Number.isInteger(selectedId)) {
        loadMember(selectedId);
      }
    });

    applyTransactionButton.addEventListener('click', () => {
      applyTransaction();
    });

    undoTransactionButton.addEventListener('click', () => {
      undoLastTransaction();
    });

    importMembersButton.addEventListener('click', () => {
      memberImportInput.click();
    });

    memberImportInput.addEventListener('change', async (event) => {
      const [file] = event.target.files;
      if (!file) {
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      const previewResponse = await fetch('/api/members/import/preview', {
        method: 'POST',
        body: formData,
      });

      if (!previewResponse.ok) {
        memberImportInput.value = '';
        setStatus('Failed to preview import.', 'fail');
        return;
      }

      const previewData = await previewResponse.json();
      if (previewData.toDelete > 0) {
        const confirmed = window.confirm(
          `Importing will remove ${previewData.toDelete} member(s) not listed and their transactions. Continue?`
        );
        if (!confirmed) {
          memberImportInput.value = '';
          setStatus('Import cancelled.', 'fail');
          return;
        }
      }

      const response = await fetch('/api/members/import', {
        method: 'POST',
        body: formData,
      });

      if (response.ok) {
        await loadMembers();
        setStatus('Members imported successfully.', 'success');
      } else {
        setStatus('Failed to import members.', 'fail');
      }

      memberImportInput.value = '';
    });

    loadMembers();
  </script>
</body>
</html>
